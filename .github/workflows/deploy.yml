name: Deploy

on:
  push:
    branches:
      - main
    paths:
      - env/dev/manifest.json
      - env/test/manifest.json
      - env/preprod/manifest.json
      - env/prod/manifest.json

jobs:
  deploy:
    runs-on: windows-2019
    strategy:
      matrix:
        env: [dev, test, preprod, prod]

    # Run only if the manifest file for the env was modified in this push
    if: contains(join(github.event.commits.*.modified, ' '), 'env/' + matrix.env + '/manifest.json')

    env:
      target_env: ${{ matrix.env }}
      target_host: ${{ fromJson('{"dev":"dev-host","test":"test-host","preprod":"preprod-host","prod":"prod-host"}')[matrix.env] }}

    steps:
      - uses: actions/checkout@v3

      - name: Show IP config
        run: ipconfig

      - name: Deploy to ${{ env.target_env }}
        shell: pwsh
        run: |
          Write-Host "Deploying to environment: $env:target_env"
          Write-Host "Deploying to host: $env:target_host"
          # Call your deployment script here
          # Example: .\scripts\deploy.ps1 -Environment $env:target_env -Host $env:target_host
